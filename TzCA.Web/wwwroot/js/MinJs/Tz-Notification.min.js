function startNotificationConnection(){$.ajax({url:"../../Account/GetUserHasLogin",type:"get",async:!1,success:function(n){n.state&&notificationConnection.start().catch(n=>consle.error(n.toString()))}})}const notificationConnection=(new signalR.HubConnectionBuilder).withUrl("/tzNotificationHub").configureLogging(signalR.LogLevel.Information).build();startNotificationConnection();notificationConnection.on("Receive",n=>{n!==null&&layer.open({title:"新通知提醒",content:"您收到了一条新的通知",time:1e4,offset:"rb",btn:[],shade:!1,anim:2,resize:!1});$(".cloudAllianceNotice").addClass("shake");setTimeout(function(){$(".cloudAllianceNotice").removeClass("shake")},5e3);let t=$(".oQNoticesList");if(t!==undefined&&n!==null){let i=' <li class="oQNoticeItem"> <a href="javascript:">     <i class="layui-icon layui-icon-log oQNoticeItemLogIcon"><\/i>      <div class="oQNoticeItem-top">         <div class="oQNoticeUserInfo">              <img class="oQNoticeUserAvatar" src="'+n.sender.minAvatar+'" alt="头像">            <h3 class="oQNoticeUserNickname">来自：<span class="oQNoticeNickname">'+n.sender.nickname+'<\/span><\/h3>       <\/div>    <\/div>    <div class="oQNoticeItem-content" title="">'+n.content+' <\/div>  <div class="oQNoticeItem-bottom">    <span class="oQNoticeType">消息来源：<span class="oQNoticeItemType">'+n.source+'<\/span><\/span>  <span class="oQNoticeItemTime">'+tzTimeAgoFormat.renderBlogArticleTimeAgo(n.sendTime)+"<\/span>     <\/div>   <\/a>  <\/li>",r=$(".oQNoticesList li:first-child");r!==undefined?r.before(i):t.append(i);notification.getUnReadCount();notification.renderContentSourceSubStr()}});var notification={send:function(n){let t={objectId:"",content:"",contentSource:"",receiverId:"",source:""};t=$.extend({},t,n);notificationConnection.invoke("Send",{ObjectId:t.objectId,ReceiverId:t.receiverId,Content:t.content,ContentSource:t.contentSource,Source:t.source}).catch(n=>console.log(n.toString()))},sendAll:function(){notificationConnection.invoke("SendSendAll",{}).catch(n=>console.log(n.toString()))},modal:function(){layui.use(["form","laydate"],function(){let n=layui.layer,t=layui.laydate;n.open({type:1,title:'未读消息通知（<span class="unReadCount"><\/span>条)',id:"OverallSituationCloudAllianceNoticeArea",shadeClose:!0,resize:!1,scrollbar:!1,area:["500px","575px"],content:'<div class="overallSituationCloudAllianceNoticeArea" id="overallSituationCloudAllianceNoticeArea"><ul class="oQNoticesList"><\/ul><\/div>'});notification.getFlowData();notification.getUnReadCount()})},getDefaultData:function(){$.ajax({url:"../../Notification/UnReadModalData",type:"get",async:!1,success:function(n){$("#overallSituationCloudAllianceNoticeArea").html(n);var t=$(".oQNoticesList").find(".oQNoticeItemTime");t!==undefined&&$.each(t,function(n,t){$(t).html(tzTimeAgoFormat.renderBlogArticleTimeAgo($(t).data("sendtime")))})}})},getFlowData:function(){layui.use("flow",function(){var n=layui.jquery,t=layui.flow;t.load({isAuto:!0,elem:".oQNoticesList",done:function(t,i){var r=[];n.get("../../Notification/GetUnRead?page="+t,function(n){layui.each(n.data,function(n,t){let i=' <li class="oQNoticeItem"> <a href="javascript:">     <i class="layui-icon layui-icon-log oQNoticeItemLogIcon"><\/i>      <div class="oQNoticeItem-top">         <div class="oQNoticeUserInfo">              <img class="oQNoticeUserAvatar" src="'+t.sender.minAvatar+'" alt="头像">            <h3 class="oQNoticeUserNickname">来自：<span class="oQNoticeNickname">'+t.sender.nickname+'<\/span><\/h3>       <\/div>    <\/div>    <div class="oQNoticeItem-content">'+t.description+' <\/div>  <div class="oQNoticeItem-bottom">    <span class="oQNoticeType">消息来源：<span class="oQNoticeItemType">'+t.source+'<\/span><\/span>  <span class="oQNoticeItemTime">'+tzTimeAgoFormat.renderBlogArticleTimeAgo(t.createTime)+"<\/span>     <\/div>   <\/a>  <\/li>";r.push(i)});i(r.join(""),t<n.count);notification.renderContentSourceSubStr()})}})})},getUnReadCount:function(){let n=0,t=$(".cloudAllianceNotice");return $.ajax({url:"../../Notification/GetUnReadCount",type:"get",async:!1,success:function(t){n=t},error:function(){layer.msg("请求超时Ծ‸Ծ")}}),n>0?t.html('<span class="layui-badge-dot cloudAllianceNoticeDot"><\/span>'):t.html(""),$(".unReadCount").text(n),n},renderContentSourceSubStr:function(){setTimeout(function(){let n=$(".oQNoticesList").find("span.contentSource"),t=$(".oQNoticesList").find("span.contentSourceUnSub");$.each(n,function(n,t){let r="",i="",u="",e="",f="";r=$(t).attr("title");u=tzEmoji.toolGetCode(r);$.each(u,function(n,t){n>3||(e+=t)});i=tzEmoji.toolReplaceCode(r);i=notification.toolSubStr(i,12);f=i;$(t).text(f)});$.each(t,function(n,t){$(t).text(notification.toolSubStr($(t).attr("title"),22))});notification.renderNotificationEmoji()},100)},toolSubStr:function(n,t){let r=n,i="";return n!==undefined&&(i=n.length<=t?n:r.substring(0,t)+"..."),i},renderNotificationEmoji:function(){tzEmoji.parse({iconPath:"../lib/",source:".oQNoticeItem-content span"})}};$(document).on("click",".cloudAllianceNotices",function(n){n.preventDefault();notification.modal()});