function toSendMessage(){var t=$("input[name=receiverConnectionId]").val(),n=$(".layim-chat-textarea textarea");if(n.val().trim()===""){layer.tips("请说点什么吧...","#sendMessageBtn",{tips:[1,"#3595CC"],time:2e3});return}connection.invoke("SendMessage",t,filterXSS(n.val())).catch(n=>console.log(n.toString()));n.val("");n.text("")}function renderOnlineUser(n,t){var i="",r;$.each(n.chatUserList,function(n,t){i+='<li layim-event="chat" data-connectionId="'+t.userId+'" data-username="'+t.nickname+'" data-type="friend" data-index="0" class="layim-friend'+t.userId+' myFriend">    <img src="'+t.avatar+'"><span>'+t.nickname+"<\/span>    <p>"+t.remark+'<\/p>    <span class="layim-msg-status msg-status-new"> new<\/span > <\/li>'});t===0&&$("#myName").data("myconnectionid")!==n.loginUser.userId&&layer.open({title:"好友上线提醒",offset:"rb",content:"【 "+n.loginUser.nickname+"】已上线。",btn:[],shade:0,anim:2,time:1e4,yes:function(){layer.close(layer.index)}});r=$("#onlineUsers");$("#onlineUsersCount").text(n.chatUserList.length);r.html(i)}function getUrl(n){let t=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.exec(n.trim());return t!==null?t[0].trim().split(/\s+/)[0]:null}function isUrl(n){var t=new RegExp("^((https|http|ftp|rtsp|mms)?://)?(([0-9a-z_!~*().&=+$%-]+: )?[0-9a-z_!~*().&=+$%-]+@)?(([0-9]{1,3}.){3}[0-9]{1,3}|([0-9a-z_!~*()-]+.)*([0-9a-z][0-9a-z-]{0,61})?[0-9a-z].[a-z]{2,6})(:[0-9]{1,4})?((/?)|(/[0-9a-z_!~*().;?:@&=+$,%#-]+)+/?)$");return t.test(n.trim())}function isLocalhostUrl(n){let t=/^(https?:\/\/)([0-9a-z.]+)(:[0-9]+)?([/0-9a-z.]+)?(\?[0-9a-z&=]+)?(#[0-9-a-z]+)?/i.exec(n.trim()),i=t[1]+t[2],r=document.location.protocol+"//"+window.document.domain;return i!==null&&i===r?!0:!1}function messageTemplate(n,t){let i=getUrl(t);return i!==null?n?'<a href="'+i+'" target="_blank" title="'+i+'" class="chat-message-link">'+t+"<\/a>":isLocalhostUrl(i)?'<a href="'+i+'" target="_blank" title="来自本站的链接！" class="chat-message-link">'+t+'<\/a><span class="is-local-url">（本站链接）<\/span>':'<a href="javascript:" data-href="'+i+'" class="chat-message-link chat-message-not-local-link" title="来自非本站链接！">'+t+'<\/a><span class="not-local-url">（非本站链接）<\/span>':t}function listenOpenNotLocalUrl(){$(".chat-message-not-local-link").off("click").on("click",function(n){let t=$(this),i=t.data("href");n.preventDefault();layer.confirm('您即将打开来自非本站的链接，是否继续？<\/br>（<span style="color:red;">官方提示：访问来自非本站链接请注意！<\/span>）',{title:"站外链接访问提示",btn:["是","否"],btnAlign:"c"},function(n){layer.close(n);window.open(i)})})}function own_init(){setTimeout(function(){connection.invoke("GetOwn").catch(n=>console.log(n.toString()))},800)}function friends_init(){setTimeout(function(){connection.invoke("GetOnlineUsers").catch(n=>console.log(n.toString()))},1e3)}function render_friends_init(){setTimeout(function(){connection.invoke("SendUserLogin").catch(n=>console.log(n.toString()))},1e3)}function init(){own_init();render_friends_init()}function reBodySize(){$("body").height($(window).height())}const connection=(new signalR.HubConnectionBuilder).withUrl("/tzChatHub").configureLogging(signalR.LogLevel.Information).build();connection.start().catch(n=>consle.error(n.toString()));connection.on("ReceiveMessage",n=>{var r=$("#myName").data("myconnectionid"),t="",u,i;if(r===n.sender.userId)t='<li class="layim-chat-mine">   <div class="layim-chat-user">       <img src = "'+n.sender.avatar+'" ><cite><i>'+n.sendTime+"<\/i>"+n.sender.nickname+'<\/cite><\/div >  <div class="layim-chat-text">'+messageTemplate(!0,n.message)+"<\/div><\/li>";else{if(u=$("input[name=receiverConnectionId]").val(),$("#chatRoom").css("display")==="none"){layer.msg(n.sender.nickname+"发来了新的消息！",function(){});return}if($("input[name=receiverConnectionId]").val()!==n.sender.userId){layer.msg(n.sender.nickname+"发来了新的消息！",function(){});return}t='<li><div class="layim-chat-user"><img src="'+n.sender.avatar+'"><cite>'+n.sender.nickname+"<i>"+n.sendTime+'<\/i><\/cite><\/div><div class="layim-chat-text"> '+messageTemplate(!1,n.message)+"<\/div><\/li>"}i=$(".layim-chat-main ul");i.append(t);$(".layim-chat-main").scrollTop(i.height());listenOpenNotLocalUrl()});$("#sendMessageBtn").on("click",function(){toSendMessage()});$(".layim-chat-textarea textarea").on("keyup",function(n){n.preventDefault();var t=n||window.event,i=t.keyCode||t.which||t.charCode;i===13&&toSendMessage()});connection.on("UserUnonline",function(n){renderOnlineUser(n,1)});connection.on("SendUserLogin",function(n){renderOnlineUser(n,0)});connection.on("GetOwn",function(n){$("#myName").text(n.nickname);$(".layui-layim-remark").val(n.remark)});connection.on("FriendsUnOnline",function(n){console.info(n)});connection.on("RenderFriendChatWindow",function(n){var t='<li class="tz-chat-messageRecordArea">     <div class="tz-chat-messageRecordTips layim-chat-text">         历史消息&nbsp;<a href="javascript:" class="tz-chat-messageHistory">查看更多<\/a>     <\/div>     <span class="tz-chat-hr"><\/span><\/li>',i;n.chatRecordContents.length>0?$.each(n.chatRecordContents,function(i,r){t+=r.ascriptionUserId!==n.sender.userId?'<li><div class="layim-chat-user"><img src="'+n.receiver.avatar+'"><cite>'+n.receiver.nickname+"<i>"+r.createTime+'<\/i><\/cite><\/div><div class="layim-chat-text"> '+messageTemplate(!1,r.message)+"<\/div><\/li>":'<li class="layim-chat-mine">   <div class="layim-chat-user">       <img src = "'+n.sender.avatar+'" ><cite><i>'+r.createTime+"<\/i>"+n.sender.nickname+'<\/cite><\/div >  <div class="layim-chat-text">'+messageTemplate(!0,r.message)+"<\/div><\/li>"}):t='<li class="tz-chat-messageRecordArea"><div class="tz-chat-messageRecordTips layim-chat-text">   还没有消息，先打个招呼吧！<\/div><span class="tz-chat-hr"><\/span><\/li>';i=$(".layim-chat-main ul");i.html(t);setTimeout(function(){$(".layim-chat-main").scrollTop(i.height(),500)},100);$("#username").text(n.receiver.nickname);$("#userAvatar").attr("src",n.receiver.avatar);$("#userRemark").text(n.receiver.remark);$("#chatRoom").show();$("input[name=receiverConnectionId]").val(n.receiver.userId);listenOpenNotLocalUrl()});$("#onlineUsers").on("dblclick",".myFriend",function(){var n=$(this),r=$("#myName").data("myconnectionid"),t=n.data("connectionid");if(r===t){layer.msg("您不能和自己发起会话！");return}connection.invoke("AddChatRecord",t).catch(n=>console.log(n.toString()));let i=n.find(".layim-msg-status");i.hasClass("msg-status-new")&&i.removeClass("msg-status-new")});$("#chatRoomClose,.chatRoomClose").click(function(){$("#chatRoom").hide()});var oldClick=null;$(".layim-list-friend>li>h5").click(function(){var n=$(this).find("span").text();if(oldClick===n){$(this).parent().find("ul").hide().parent().siblings().find("ul").hide();oldClick=null;return}$(this).parent().find("ul").show().parent().siblings().find("ul").hide();oldClick=n});$(document).on("click",".tz-chat-messageHistory",function(n){n.preventDefault();layer.msg("别急嘛，人家正在撸代码实现呢~")});$(document).on("click",".chatTodo",function(n){n.preventDefault();layer.msg("别急嘛，人家正在撸代码实现呢~")});$(".userConfigure").on("click",function(n){n.preventDefault();layer.confirm("您确定要退出系统吗？",{btn:["确定","取消"]},function(){window.location.href="../Account/Logout"})});window.onresize=function(){reBodySize()};window.onload=function(){setTimeout(function(){init()},500);reBodySize()};$(".myFriendsPanel").css("left","");