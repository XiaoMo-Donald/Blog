function toSendMessage(){var t=$("input[name=receiverConnectionId]").val(),n=$(".layim-chat-textarea textarea");if(n.val().trim()===""){layer.tips("请说点什么吧...","#sendMessageBtn",{tips:[1,"#3595CC"],time:2e3});return}connection.invoke("SendMessage",t,filterXSS(n.val())).catch(n=>console.log(n.toString()));n.val("");n.text("")}function renderOnlineUser(n){var t="",i;$.each(n.chatUserList,function(n,i){t+='<li layim-event="chat" data-connectionId="'+i.userId+'" data-username="'+i.nickname+'" data-type="friend" data-index="0" class="layim-friend'+i.userId+' myFriend">    <img src="'+i.avatar+'"><span>'+i.nickname+"<\/span>    <p>"+i.remark+'<\/p><span class="layim-msg-status">new<\/span><\/li>'});$("#myName").data("myconnectionid")!==n.loginUser.userId&&layer.open({icon:1,offset:"rb",content:"用户【 "+n.loginUser.nickname+"】上线了。",btn:[],shade:0,anim:2,time:1e4,yes:function(){layer.close(layer.index)}});i=$("#onlineUsers");$("#onlineUsersCount").text(n.chatUserList.length);i.html(t)}function own_init(){setTimeout(function(){connection.invoke("GetOwn").catch(n=>console.log(n.toString()))},800)}function friends_init(){setTimeout(function(){connection.invoke("GetOnlineUsers").catch(n=>console.log(n.toString()))},1e3)}function render_friends_init(){setTimeout(function(){connection.invoke("SendUserLogin").catch(n=>console.log(n.toString()))},1e3)}function init(){own_init();render_friends_init()}function reBodySize(){$("body").height($(window).height())}const connection=(new signalR.HubConnectionBuilder).withUrl("/tzChatHub").configureLogging(signalR.LogLevel.Information).build();connection.start().catch(n=>consle.error(n.toString()));connection.on("ReceiveMessage",n=>{var r=$("#myName").data("myconnectionid"),t="",u,i;if(r===n.sender.userId)t='<li class="layim-chat-mine">   <div class="layim-chat-user">       <img src = "'+n.sender.avatar+'" ><cite><i>'+n.sendTime+"<\/i>"+n.sender.nickname+'<\/cite><\/div >  <div class="layim-chat-text">'+n.message+"<\/div><\/li>";else{if(u=$("input[name=receiverConnectionId]").val(),$("#chatRoom").css("display")==="none"){layer.msg(n.sender.nickname+"发来了新的消息！",function(){});return}if($("input[name=receiverConnectionId]").val()!==n.sender.userId){layer.msg(n.sender.nickname+"发来了新的消息！",function(){});return}t='<li><div class="layim-chat-user"><img src="'+n.sender.avatar+'"><cite>'+n.sender.nickname+"<i>"+n.sendTime+'<\/i><\/cite><\/div><div class="layim-chat-text"> '+n.message+"<\/div><\/li>"}i=$(".layim-chat-main ul");i.append(t);$(".layim-chat-main").scrollTop(i.height())});$("#sendMessageBtn").on("click",function(){toSendMessage()});$(".layim-chat-textarea textarea").on("keyup",function(n){n.preventDefault();var t=n||window.event,i=t.keyCode||t.which||t.charCode;i===13&&toSendMessage()});connection.on("UserUnonline",function(n){renderOnlineUser(n)});connection.on("SendUserLogin",function(n){renderOnlineUser(n)});connection.on("GetOwn",function(n){$("#myName").text(n.nickname);$(".layui-layim-remark").val(n.remark)});connection.on("UserUnOnline",function(n){layer.msg(n,{icon:5})});connection.on("RenderFriendChatWindow",function(n){var t='<li class="tz-chat-messageRecordArea">     <div class="tz-chat-messageRecordTips layim-chat-text">         历史消息&nbsp;<a href="javascript:" class="tz-chat-messageHistory">查看更多<\/a>     <\/div>     <span class="tz-chat-hr"><\/span><\/li>',i;n.chatRecordContents.length>0?$.each(n.chatRecordContents,function(i,r){t+=r.ascriptionUserId!==n.sender.userId?'<li><div class="layim-chat-user"><img src="'+n.receiver.avatar+'"><cite>'+n.receiver.nickname+"<i>"+r.createTime+'<\/i><\/cite><\/div><div class="layim-chat-text"> '+r.message+"<\/div><\/li>":'<li class="layim-chat-mine">   <div class="layim-chat-user">       <img src = "'+n.sender.avatar+'" ><cite><i>'+r.createTime+"<\/i>"+n.sender.nickname+'<\/cite><\/div >  <div class="layim-chat-text">'+r.message+"<\/div><\/li>"}):t='<li class="tz-chat-messageRecordArea"><div class="tz-chat-messageRecordTips layim-chat-text">   还没有消息，先打个招呼吧！<\/div><span class="tz-chat-hr"><\/span><\/li>';i=$(".layim-chat-main ul");i.html(t);setTimeout(function(){$(".layim-chat-main").scrollTop(i.height(),500)},100);$("#username").text(n.receiver.nickname);$("#userAvatar").attr("src",n.receiver.avatar);$("#userRemark").text(n.receiver.remark);$("#chatRoom").show();$("input[name=receiverConnectionId]").val(n.receiver.userId)});$("#onlineUsers").on("dblclick",".myFriend",function(){var t=$(this),i=$("#myName").data("myconnectionid"),n=t.data("connectionid");if(i===n){layer.msg("您不能和自己发起会话！");return}connection.invoke("AddChatRecord",n).catch(n=>console.log(n.toString()))});$("#chatRoomClose,.chatRoomClose").click(function(){$("#chatRoom").hide()});var oldClick=null;$(".layim-list-friend>li>h5").click(function(){var n=$(this).find("span").text();if(oldClick===n){$(this).parent().find("ul").hide().parent().siblings().find("ul").hide();oldClick=null;return}$(this).parent().find("ul").show().parent().siblings().find("ul").hide();oldClick=n});$(document).on("click",".tz-chat-messageHistory",function(n){n.preventDefault();layer.msg("别急嘛，人家正在撸代码实现呢~")});$(document).on("click",".chatTodo",function(n){n.preventDefault();layer.msg("别急嘛，人家正在撸代码实现呢~")});$(".userConfigure").on("click",function(n){n.preventDefault();layer.confirm("您确定要退出系统吗？",{btn:["确定","取消"]},function(){window.location.href="../Account/Logout"})});window.onresize=function(){reBodySize()};window.onload=function(){setTimeout(function(){init()},500);reBodySize()};$(".myFriendsPanel").css("left","");